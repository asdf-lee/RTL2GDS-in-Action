name: Digital flow test

on:
  workflow_dispatch:

jobs:
  install-and-run:
    runs-on: ubuntu-22.04

    steps:
    # Step 1: Checkout
    - name: Check out repository
      uses: actions/checkout@v4

    # Step 2: Update system
    - name: Update and upgrade system
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y

    # Step 3: Install required system packages
    - name: Install required packages
      run: |
        sudo apt install -y build-essential python3 python3-venv python3-pip python3-tk curl make git
        # build-essential: Compilation tools
        # python3, python3-venv, python3-pip: Python setup
        # python3-tk: Required for graphical Python applications
        # curl, make, git: Utilities for development
        # docker.io: For running Docker containers

    # Step 4: Verify installations
    - name: Verify Docker and Python installations
      run: |
        docker --version
        python3 --version
        python3 -m pip --version

    # Step 5: Install OpenLane
    - name: Install OpenLane
      run: python3 -m pip install openlane

    # Step 6: Run OpenLane
    - name: Run OpenLane
      run: |
        cd my_project
        python3 -m openlane --docker-no-tty --dockerized config.json

    # Step 7: Locate GDS file
    - name: Find and save GDS file and RUN directory
      run: |
        LAST_RUN_DIR=$(ls -d ${{ github.workspace }}/my_project/runs/RUN_* | sort | tail -n 1)
        echo "Last run directory: $LAST_RUN_DIR"

        GDS_FILE=$(find "$LAST_RUN_DIR/final/gds" -type f -name "*.gds" | head -n 1)

        echo ">> Contents of final/gds:"
        ls "$LAST_RUN_DIR/final/gds/"

        if [ -n "$GDS_FILE" ]; then
          echo "GDS file found: $GDS_FILE"
          echo "gds_path=$GDS_FILE" >> $GITHUB_ENV
          echo "last_run_dir=$LAST_RUN_DIR" >> $GITHUB_ENV
        else
          echo "Error: No GDS file found!"
          exit 1
        fi

    # Step 8: Collect KLayout Render PNGs (out.png) + final PNG if present
    - name: Collect KLayout renders and final PNG
      run: |
        mkdir -p Imgs
    
        echo "Searching for all out.png renders..."
    
        # Buscar y ORDENAR todos los renders
        renders=($(find "${{ github.workspace }}/my_project/runs" -type f -name "out.png" | sort))
    
        echo "Found ${#renders[@]} renders"
    
        # Asignar nombres semánticos según el orden
        if [ ${#renders[@]} -ge 1 ]; then
          cp "${renders[0]}" Imgs/Post_GeneratePDN.png
        fi
        
        if [ ${#renders[@]} -ge 2 ]; then
          cp "${renders[1]}" Imgs/Post_DetailedPlacement.png
        fi
    
        if [ ${#renders[@]} -ge 3 ]; then
          cp "${renders[2]}" Imgs/Post_DetailedRouting.png
        fi
    
        # PNG final si existe
        if [ -n "${{ env.png_path }}" ] && [ -f "${{ env.png_path }}" ]; then
          echo "Copying final PNG ${{ env.png_path }} → Imgs/GDS_final.png"
          cp "${{ env.png_path }}" Imgs/GDS_final.png
        else
          echo "No final PNG found (env.png_path is empty or missing)"
        fi
    
        echo "Listing collected images:"
        ls -1 Imgs || true

    # Step 9: Upload GDS
    - name: Upload GDS file as artifact
      if: ${{ env.gds_path != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: myproject-gds
        path: ${{ env.gds_path }}
        if-no-files-found: warn

    # Step 10: Upload all KLayout renders (Imgs/)
    - name: Upload KLayout renders artifact
      uses: actions/upload-artifact@v4
      with:
        name: klayout-renders
        path: Imgs/
        if-no-files-found: warn
