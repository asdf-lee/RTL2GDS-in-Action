name: Digital flow test

on:
  workflow_dispatch:

jobs:
  install-and-run:
    runs-on: ubuntu-22.04

    steps:
    # Step 1: Checkout
    - name: Check out repository
      uses: actions/checkout@v4

    # Step 2: Update system
    - name: Update and upgrade system
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y

    # Step 3: Install required system packages
    - name: Install required packages
      run: |
        sudo apt install -y build-essential python3 python3-venv python3-pip python3-tk curl make git
        # build-essential: Compilation tools
        # python3, python3-venv, python3-pip: Python setup
        # python3-tk: Required for graphical Python applications
        # curl, make, git: Utilities for development
        # docker.io: For running Docker containers

    # Step 4: Verify installations
    - name: Verify Docker and Python installations
      run: |
        docker --version
        python3 --version
        python3 -m pip --version

    # Step 5: Install OpenLane
    - name: Install OpenLane
      run: python3 -m pip install openlane

    # Step 6: Run OpenLane
    - name: Run OpenLane
      run: |
        cd my_project
        python3 -m openlane --docker-no-tty config.json

    # Step 7: Locate GDS file
    - name: Find and save GDS file and RUN directory
      run: |
        LAST_RUN_DIR=$(ls -d ${{ github.workspace }}/my_project/runs/RUN_* | sort | tail -n 1)
        echo "Last run directory: $LAST_RUN_DIR"

        GDS_FILE=$(find "$LAST_RUN_DIR/final/gds" -type f -name "*.gds" | head -n 1)

        echo ">> Contents of final/gds:"
        ls "$LAST_RUN_DIR/final/gds/"

        if [ -n "$GDS_FILE" ]; then
          echo "GDS file found: $GDS_FILE"
          echo "gds_path=$GDS_FILE" >> $GITHUB_ENV
          echo "last_run_dir=$LAST_RUN_DIR" >> $GITHUB_ENV
        else
          echo "Error: No GDS file found!"
          exit 1
        fi

    # Step 8: Convert GDS to PNG
    - name: Convert GDS to PNG with KLayout
      run: |
        sudo apt-get install -y klayout
        PNG_OUT=${{ github.workspace }}/my_project/final_layout.png

        echo "Generating PNG..."
        klayout -b -rd in=${{ env.gds_path }} -rd out=$PNG_OUT -r 'layout = pya.Layout(); layout.read($in); layout.write_image($out, 4000, 4000);'

        echo "png_path=$PNG_OUT" >> $GITHUB_ENV

    # Step 9: Collect all KLayout renders (out.png)
    - name: Collect KLayout Render PNGs
      run: |
        mkdir -p Imgs
        i=1
        echo "Searching for all out.png renders..."
        for file in $(find ${{ github.workspace }}/my_project/runs -name "out.png"); do
          echo "Found render: $file"
          cp "$file" "Imgs/out_$i.png"
          i=$((i+1))
        done
        ls -l Imgs/

    # Step 10: Upload GDS
    - name: Upload GDS file as artifact
      uses: actions/upload-artifact@v4
      with:
        name: myproject-gds
        path: ${{ env.gds_path }}

    # Step 11: Upload final PNG
    - name: Upload layout PNG as artifact
      uses: actions/upload-artifact@v4
      with:
        name: myproject-png
        path: ${{ env.png_path }}

    # Step 12: Upload all KLayout renders
    - name: Upload KLayout renders artifact
      uses: actions/upload-artifact@v4
      with:
        name: klayout-renders
        path: Imgs/
        if-no-files-found: warn
