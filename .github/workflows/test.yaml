name: Digital flow test

on:
  workflow_dispatch:

jobs:
  install-and-run:
    runs-on: ubuntu-22.04

    steps:
    # Step 1: Checkout
    - name: Check out repository
      uses: actions/checkout@v4

    # Step 2: Update system
    - name: Update and upgrade system
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y

    # Step 3: Install required system packages
    - name: Install required packages
      run: |
        sudo apt install -y build-essential python3 python3-venv python3-pip python3-tk curl make git
        # build-essential: Compilation tools
        # python3, python3-venv, python3-pip: Python setup
        # python3-tk: Required for graphical Python applications
        # curl, make, git: Utilities for development
        # docker.io: For running Docker containers

    # Step 4: Verify installations
    - name: Verify Docker and Python installations
      run: |
        docker --version
        python3 --version
        python3 -m pip --version

    # Step 5: Install OpenLane
    - name: Install OpenLane
      run: python3 -m pip install openlane

    # Step 6: Run OpenLane
    - name: Run OpenLane
      run: |
        cd my_project
        python3 -m openlane --docker-no-tty --dockerized config.json

    # Step 7: Locate GDS file
    - name: Find and save GDS file and RUN directory
      run: |
        LAST_RUN_DIR=$(ls -d ${{ github.workspace }}/my_project/runs/RUN_* | sort | tail -n 1)
        echo "Last run directory: $LAST_RUN_DIR"

        GDS_FILE=$(find "$LAST_RUN_DIR/final/gds" -type f -name "*.gds" | head -n 1)

        echo ">> Contents of final/gds:"
        ls "$LAST_RUN_DIR/final/gds/"

        if [ -n "$GDS_FILE" ]; then
          echo "GDS file found: $GDS_FILE"
          echo "gds_path=$GDS_FILE" >> $GITHUB_ENV
          echo "last_run_dir=$LAST_RUN_DIR" >> $GITHUB_ENV
        else
          echo "Error: No GDS file found!"
          exit 1
        fi

    # Step 8: Collect KLayout Render PNGs (out.png) + final PNG if present
    - name: Collect and rename KLayout renders by step
      run: |
        mkdir -p Imgs
    
        echo "Searching for all out.png renders..."
    
        # Buscar todos los archivos 'out.png'
        find "${{ github.workspace }}/my_project/runs" -type f -name "out.png" 2>/dev/null \
          | while read file; do
            
            # Obtener carpeta padre
            folder=$(dirname "$file")
            folder_base=$(basename "$folder")
    
            echo "Found render in folder: $folder_base"
    
            # Nombre por defecto
            newname="unknown.png"
    
            # MAPEO seg√∫n paso OpenLane
            case "$folder_base" in
              *generate-pdn* )
                newname="Post_GeneratePDN.png"
                ;;
              *detailed-placement* )
                newname="Post_DetailedPlacement.png"
                ;;
              *detailed-routing* )
                newname="Post_DetailedRouting.png"
                ;;
              *fill-insertion* )
                newname="Post_FillInsertion.png"
                ;;
            esac
    
            echo "Renaming to Imgs/$newname"
            cp "$file" "Imgs/$newname"
          done
    
        echo "Listing collected images:"
        ls -1 Imgs || true

    # Step 9: Upload GDS
    - name: Upload GDS file as artifact
      if: ${{ env.gds_path != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: myproject-gds
        path: ${{ env.gds_path }}
        if-no-files-found: warn

    # Step 10: Upload all KLayout renders (Imgs/)
    - name: Upload KLayout renders artifact
      uses: actions/upload-artifact@v4
      with:
        name: klayout-renders
        path: Imgs/
        if-no-files-found: warn
